/**
</> Original base BochilGaming 
</> Recode simple by @NeKosmic
**/

import{format}from"util";import db from"../lib/database.js";const debugMode=!1;export async function before(e){let t,r=!1,n=!1,a=!1;this.game=this.game?this.game:{};const i=Object.values(this.game).find((t=>t.id&&t.game&&t.state&&t.id.startsWith("tictactoe")&&[t.game.playerX,t.game.playerO].includes(e.sender)&&"PLAYING"==t.state));if(i){const s=/^(rendirse)$/i.test(e.text)?99:4999;if(!/^([1-9]|rendirse)$/i.test(e.text))return!0;if(a=!/^[1-9]$/.test(e.text),e.sender!==i.game.currentTurn&&!a)return!0;if(debugMode&&e.reply("[DEBUG]\n"+require("util").format({isSurrender:a,text:e.text})),!a&&1>(t=i.game.turn(e.sender===i.game.playerO,parseInt(e.text)-1)))return e.reply({"-3":"El juego ha terminado","-2":"Inválido","-1":"Posición inválida",0:"Posición inválida"}[t]),!0;e.sender===i.game.winner?r=!0:511===i.game.board&&(n=!0);const o=i.game.render().map((e=>({X:"❌",O:"⭕",1:"1️⃣",2:"2️⃣",3:"3️⃣",4:"4️⃣",5:"5️⃣",6:"6️⃣",7:"7️⃣",8:"8️⃣",9:"9️⃣"}[e])));a&&(i.game._currentTurn=e.sender===i.game.playerX,r=!0);const m=a?i.game.currentTurn:i.game.winner,d=`\n${r?`@${(a?i.game.currentTurn:i.game.winner).split("@")[0]} Victoria! (+${s} XP)`:n?"Juego terminado, empate (+99 XP)":`Turno de @${i.game.currentTurn.split("@")[0]}`}\n\n${o.slice(0,3).join("")}\n${o.slice(3,6).join("")}\n${o.slice(6).join("")}\n        \n❌ = @${i.game.playerX.split("@")[0]}\n⭕ = @${i.game.playerO.split("@")[0]}\n\n~Escriba :~\n\nrendirse\n\n~para darse por vencido~\n`.trim(),u=db.data.users;(i.game._currentTurn^a?i.x:i.o)!==e.chat&&(i[i.game._currentTurn^a?"x":"o"]=e.chat),i.x!==i.o&&await this.sendMessage(i.x,{text:d,mentions:this.parseMention(d)},{quoted:e}),await this.sendMessage(i.o,{text:d,mentions:this.parseMention(d)},{quoted:e}),(n||r)&&(u[i.game.playerX].exp+=99,u[i.game.playerO].exp+=99,r&&(u[m].exp+=s-99),debugMode&&e.reply("[DEBUG]\n"+format(i)),delete this.game[i.id])}return!0}

/**
[_>] https://github.com/NeKosmic/
[_>] https://gitlab.com/NeKosmic/
**/