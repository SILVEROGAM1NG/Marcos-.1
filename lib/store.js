/**
</> Original base BochilGaming 
**/
import{readFileSync as e,writeFileSync as t,existsSync as n,promises as a}from"fs";import{join as s}from"path";const{initAuthCreds:i,BufferJSON:o,proto:c,isJidBroadcast:r,isJidGroup:d,WAMessageStubType:u,updateMessageWithReceipt:f,updateMessageWithReaction:p,useMultiFileAuthState:m}=(await import("@adiwajshing/baileys")).default,l=3e5;function g(e,t){if(null==t)return;return o.replacer(e,t)}const y=e=>e?.replace(/\//g,"__")?.replace(/:/g,"-"),h=m||async function(e){const t=(t,n)=>a.writeFile(s(e,y(n)),JSON.stringify(t,g)),n=async t=>{try{const n=await a.readFile(s(e,y(t)),{encoding:"utf-8"});return JSON.parse(n,o.reviver)}catch(e){return null}},r=async e=>{try{await a.unlink(y(e))}catch{}},d=await a.stat(e).catch((()=>{}));if(d){if(!d.isDirectory())throw new Error(`found something that is not a directory at ${e}, either delete it or specify a different location`)}else await a.mkdir(e,{recursive:!0});const u=await n("creds.json")||i();return{state:{creds:u,keys:{get:async(e,t)=>{const a={};return await Promise.all(t.map((async t=>{let s=await n(`${e}-${t}.json`);"app-state-sync-key"===e&&(s=c.AppStateSyncKeyData.fromObject(s)),a[t]=s}))),a},set:async e=>{const n=[];for(const a in e)for(const s in e[a]){const i=e[a][s],o=`${a}-${s}.json`;n.push(i?t(i,o):r(o))}await Promise.all(n)}}},saveCreds:()=>t(u,"creds.json")}},b={"pre-key":"preKeys",session:"sessions","sender-key":"senderKeys","app-state-sync-key":"appStateSyncKeys","app-state-sync-version":"appStateVersions","sender-key-memory":"senderKeyMemory"};export default{makeInMemoryStore:function(){let a={},s={},i={connection:"close"};function o(e,t=null){let n=null;if(e&&!t){t=e;const a=e=>e.key?.id==t,i=Object.entries(s).find((([,e])=>e.find(a)));n=i?.[1]?.find(a)}else{if(e=e?.decodeJid?.(),!(e in s))return null;n=s[e].find((e=>e.key.id==t))}return n||null}async function m(e,t){if(e=e?.decodeJid?.(),!d(e))return;if(!(e in a))return a[e]={id:e};if(!a[e].metadata||Date.now()-(a[e].lastfetch||0)>l){const n=await(t?.(e));n&&Object.assign(a[e],{subject:n.subject,lastfetch:Date.now(),metadata:n})}return a[e].metadata}const g=(e,t,n="append")=>{e=e?.decodeJid?.(),e in s||(s[e]=[]),delete t.message?.messageContextInfo,delete t.message?.senderKeyDistributionMessage;const a=o(e,t.key.id);a?Object.assign(a,t):"append"==n?s[e].push(t):s[e].splice(0,0,t)};return{chats:a,messages:s,state:i,loadMessage:o,fetchGroupMetadata:m,fetchMessageReceipts:function(e){const t=o(e);return t?t.userReceipt:null},fetchImageUrl:async function(e,t){if(e=e?.decodeJid?.(),!(e in a))return a[e]={id:e};if(!a[e].imgUrl){const n=await t(e,"image").catch((()=>"./multimedia/imagenes/avatar_contact.png"));n&&(a[e].imgUrl=n)}return a[e].imgUrl},getContact:function(e){return e=e?.decodeJid?.(),e in a?a[e]:null},bind:function(e,t={groupMetadata:()=>null}){e.on("connection.update",(e=>{Object.assign(i,e)})),e.on("chats.set",(function(e){for(const t of e.chats){const e=t.id?.decodeJid?.();e&&(e in a||(a[e]={...t,isChats:!0,...t.name?{name:t.name}:{}}),t.name&&(a[e].name=t.name))}})),e.on("contacts.set",(function(e){for(const t of e.contacts){const e=t.id?.decodeJid?.();e&&(a[e]=Object.assign(a[e]||{},{...t,isContact:!0}))}})),e.on("messages.set",(function(e){for(const t of e.messages){const e=t.key.remoteJid?.decodeJid?.();if(!e)continue;if(!e||r(e))continue;e in s||(s[e]=[]);o(e,t.key.id);g(e,c.WebMessageInfo.fromObject(t),"prepend")}})),e.on("contacts.update",(function(e){for(const t of e){const e=t.id?.decodeJid?.();e&&(a[e]=Object.assign(a[e]||{},{id:e,...t,isContact:!0}))}})),e.on("chats.upsert",(async function(e){await Promise.all(e.map((async e=>{const n=e.id?.decodeJid?.();if(!n||r(n))return;n in a||(a[n]={id:n,...e,isChats:!0});const s=d(n);Object.assign(a[n],{...e,isChats:!0}),s&&!a[n].metadata&&Object.assign(a[n],{metadata:await m(n,t.groupMetadata)})})))})),e.on("chats.update",(function(e){for(const t of e){const e=t.id?.decodeJid?.();e&&(e in a||(a[e]={id:e,...t,isChats:!0}),t.unreadCount&&(t.unreadCount+=a[e].unreadCount||0),Object.assign(a[e],{id:e,...t,isChats:!0}))}})),e.on("presence.update",(function(e){const t=e.id?.decodeJid?.();t&&(t in a||(a[t]={id:t,isContact:!0}),Object.assign(a[t],e))})),e.on("messages.upsert",(function(t){const{messages:n,type:i}=t;switch(i){case"append":case"notify":for(const t of n){const n=t.key.remoteJid?.decodeJid?.();if(!n||r(n))continue;if(t.messageStubType==u.CIPHERTEXT)continue;n in s||(s[n]=[]);o(n,t.key.id);g(n,c.WebMessageInfo.fromObject(t)),"notify"!==i||n in a||e.emit("chats.upsert",[{id:n,conversationTimestamp:t.messageTimestamp,unreadCount:1,name:t.pushName||t.verifiedBizName}])}}})),e.on("messages.update",(function(e){for(const t of e){const e=t.key.remoteJid?.decodeJid?.();if(!e)continue;const n=t.key.id;if(!e||r(e))continue;e in s||(s[e]=[]);if(!o(e,n))return;if(t.update.messageStubType==u.REVOKE)continue;const a=s[e].findIndex((e=>e.key.id===n));Object.assign(s[e][a],t.update)}})),e.on("groups.update",(async function(e){await Promise.all(e.map((async e=>{const n=e.id?.decodeJid?.();if(!n)return;d(n)&&(n in a||(a[n]={id:n,...e,isChats:!0}),a[n].metadata||Object.assign(a[n],{metadata:await m(n,t.groupMetadata)}),Object.assign(a[n].metadata,e))})))})),e.on("group-participants.update",(async function(e){const n=e.id?.decodeJid?.();if(!n||!d(n))return;n in a&&a[n].metadata||Object.assign(a[n],{metadata:await m(n,t.groupMetadata)});const s=a[n].metadata;if(!s)return console.log(`Try to update group ${n} but metadata not found in 'group-participants.update'`);switch(e.action){case"add":s.participants.push(...e.participants.map((e=>({id:e,admin:null}))));break;case"demote":case"promote":for(const t of s.participants)e.participants.includes(t.id)&&(t.admin="promote"===e.action?"admin":null);break;case"remove":s.participants=s.participants.filter((t=>!e.participants.includes(t.id)))}Object.assign(a[n],{metadata:s})})),e.on("message-receipt.update",(function(e){for(const{key:t,receipt:n}of e){const e=t.remoteJid?.decodeJid?.();if(!e)continue;const a=t.id;e in s||(s[e]=[]);const i=o(e,a);if(!i)return;f(i,n)}})),e.on("messages.reaction",(function(e){for(const{key:t,reaction:n}of e){const e=t.remoteJid?.decodeJid?.();if(!e)continue;const a=o(e,t.id);if(!a)return;p(a,n)}}))},writeToFile:function(e){t(e,JSON.stringify({chats:a,messages:s},((e,t)=>"isChats"==e?void 0:t),2))},readFromFile:function(t){if(n(t)){!function(e){Object.assign(a,e.chats);for(const t in e.messages)s[t]=e.messages[t].map((e=>e&&c.WebMessageInfo.fromObject(e))).filter((e=>e&&e.messageStubType!=u.CIPHERTEXT))}(JSON.parse(e(t,{encoding:"utf-8"})))}}}},useMultiFileAuthState:h,useMemoryAuthState:function(){const e=i(),t={};return{state:{creds:e,keys:{get:(e,n)=>{const a=b[e];return n.reduce(((n,s)=>{let i=t[a]?.[s];return i&&("app-state-sync-key"===e&&(i=c.AppStateSyncKeyData.fromObject(i)),n[s]=i),n}),{})},set:e=>{for(const n in e){const a=b[n];t[a]=t[a]||{},Object.assign(t[a],e[n])}}}},saveCreds:()=>{}}},fixFileName:y,JSONreplacer:g,KEY_MAP:b};